#! /bin/bash
#
# File: confh
# Version: 12.2018.1
# Author: BreadyX
#
# A simple utility to manage the mos important config files

CUR_VER=$( sed '4q;d' ~/.local/bin/confh | cut -d ' ' -f3)

RED=$(tput setaf 196)
RESET=$(tput sgr0)

function _check_ver {
	if [ "$1" -gt "$4" ] || [ "$2" -gt "$5" ] || [ "$3" -gt "$6" ]; then
		echo "New version $1.$2.$3 found online ( Old: $4.$5.$6 )."
		return 0
	else
		echo "Already up to date."
		return 1
	fi
}

function _bashrc {
	case $1 in
		"-e"|"--edit")
			echo "Opening ~/.bashrc in $EDITOR"
			[ -z "$EDITOR" ] && { echo "${RED}Variable EDITOR is not set, using nano$RESET" > /dev/stderr; sleep 1; nano ~/.bashrc; return 0; }
			$EDITOR ~/.bashrc
			return 0
			;;
		"-s"|"--resource")
			echo "Resourcing ~/.bashrc"
			source ~/.bashrc
			return $?
			;;
		"-u"|"--update")
			local REPO="https://raw.githubusercontent.com/BreadyX/dotfiles/master/.bashrc"
			LOCAL_VERSION=( $(sed '3q;d' ~/.bashrc | cut -d ' ' -f3 | sed 's/\./ /g') )
			( cd /tmp || { echo "${RED}/tmp is not available, please fix${RESET}" > /dev/stderr ; return 1; }
			echo "Checking for updates..."
			wget -V &> /dev/null || { echo "${RED}wget is not installed. Please install wget and then continue$RESET" > /dev/stderr ; }
			wget -O .bashrc $REPO &> /dev/null
			REMOTE_VERSION=( $(sed '3q;d' ./.bashrc | cut -d ' ' -f3 | sed 's/\./ /g') )
			if _check_ver "${REMOTE_VERSION[@]}" "${LOCAL_VERSION[@]}"; then
				if [ "$2" == "--dry-run" ] || [ "$3" == "--dry-run" ]; then rm ./.bashrc; exit 0; fi
				echo "Installing..."
				cp ./.bashrc ~
			fi
			echo "Cleaning up..."
			rm ./.bashrc; )
			source ~/.bashrc
			exit $?
			;;
		"*")
			echo "Unknown option $1, please see confh --help for info about usage"
			return 1
			;;
	esac
}

function _bash_profile {
	case $1 in
		"-e"|"--edit")
			echo "Opening ~/.bash_profile in $EDITOR"
			[ -z "$EDITOR" ] && { echo "${RED}Variable EDITOR is not set, using nano$RESET" > /dev/stderr; sleep 1; nano ~/.bash_profile; return 0; }
			$EDITOR ~/.bash_profile
			return 0
			;;
		"-s"|"--resource")
			echo "Resourcing ~/.bash_profile"
			source ~/.bash_profile
			return $?
			;;
		"-u"|"--update")
			local REPO="https://raw.githubusercontent.com/BreadyX/dotfiles/master/.bash_profile"
			LOCAL_VERSION=( $(sed '3q;d' ~/.bash_profile | cut -d ' ' -f3 | sed 's/\./ /g') )
			( cd /tmp || { echo "${RED}/tmp is not available, please fix$RESET" > /dev/stderr ; return 1; }
			echo "Checking for updates..."
			wget -V &> /dev/null || { echo "${RED}wget is not installed. Please install wget and then continue$RESET" > /dev/stderr ; }
			wget -O .bash_profile $REPO &> /dev/null
			REMOTE_VERSION=( $(sed '3q;d' ./.bash_profile | cut -d ' ' -f3 | sed 's/\./ /g') )
			if _check_ver "${REMOTE_VERSION[@]}" "${LOCAL_VERSION[@]}"; then
				if [ "$2" == "--dry-run" ] || [ "$3" == "--dry-run" ]; then rm ./.bash_profile; exit 0; fi
				echo "Installing..."
				cp ./.bash_profile ~
			fi
			echo "Cleaning up..."
			rm ./.bash_profile; )
			source ~/.bash_profile
			exit $?
			;;
		"*")
			echo "Unknown option $1, please see confh --help for info about usage"
			return 1
			;;
	esac
}

function _init_vim {
    echo "$(tput setaf 196)NOT YET FULLY IMPLEMENTED, DON'T EXPECT CORRECT BEHAVIOUR$(tput sgr0)"
	case $1 in
		"-e"|"--edit")
			echo "Do you want to open one of init.vim's modules (default yes)? [Y/N]"
			read -r INPUT;
			if [ "${INPUT,,}" == "n" ]; then
				echo "Opening init.vim in $EDITOR"
				[ -z "$EDITOR" ] && { echo "${RED}Variable EDITOR is not set, using nano$RESET" > /dev/stderr; sleep 1; nano ~/.config/nvim/init.vim; }
				$EDITOR ~/.config/nvim/init.vim
				return 0
			else
				echo "Which module do you want to open (default init.vim)"
				MODULES=( $(dir ~/.config/nvim/*.vim) )
				for (( i=0; i<${#MODULES[@]}; i++ )); do echo "[$i] $(basename "${MODULES[$i]}")"; done
				read -r INPUT
				case $INPUT in
					*[!0-9]*)
						echo "${RED}Selection '$INPUT' is invalid$RESET" > /dev/stderr; return 1
						;;
					'')
						[ -z "$EDITOR" ] && { echo "${RED}Variable EDITOR is not set, using nano$RESET" > /dev/stderr; sleep 1; nano ~/.config/nvim/init.vim; return 0; }
						$EDITOR ~/.config/nvim/init.vim
						return 0
						;;
					*)
						[ -z "${MODULES[$INPUT]}" ] && { echo "${RED}Selection '$INPUT' is invalid$RESET" > /dev/stderr; return 1; }
						[ -z "$EDITOR" ] && { echo "${RED}Variable EDITOR is not set, using nano$RESET" > /dev/stderr; sleep 1; nano "${MODULES[$INPUT]}"; return 0; }
						$EDITOR "${MODULES[$INPUT]}"
						return 0
						;;
				esac
			fi
			;;
		"-u"|"--upgrade")
			if [ "$3" == "--all" ] || [ "$4" == "--all" ]; then
				echo "Upgrading all vim config files"
				( echo "starting procedure"; )
			else
				echo "Choose which files to upgrade:"
			fi
			;;
		*)
			echo "Unknown option $1, please see conf --help for info about usage"
			return 1
			;;
		esac
}

### SCRIPTINGS
case $1 in
	"--help"|"-h")
		cat << EOF
confh [CONF] [OPTION]
Info commands:
	confh --help|-h
	confh --version|-v

A helper for editing/sourcing/updating config files. This script handles :
	- .bashrc
	- .bash_profile
	- init.vim
Only this small set of scripts is handled because they are the most useful of the bunch.

INFO:
	confh --help 	displays this message
	confh --version displays information about the version installed

CONF:
	-b --bashrc		operate one the .bashrc file
	-B --bash_profile	operate on the .bash_profile
	-V --initvim		operate on the init.vim file
OPTIONS:
	-e  --edit		edit the file
	-u  --update		update the file to the latest version avialable from the github repo
	-s  --resource		(ONLY FOR .bashrc AND .bash_profile) resource the file
	    --dry-run		only checks for updates but doesn't apply anything
	    --all		(ONLY FOR init.vim) update all the modules without asking
EOF
		exit 0
		;;
	"--version"|"-v")
		cat << EOF
confh - Part of BreadyX's utils (BXU)
Current version: $CUR_VER
EOF
		;;
	"--bashrc"|"-b")
		_bashrc "$2" "$3"
		exit $?
		;;
	"--bash_profile"|"-B")
		_bash_profile "$2"
		exit $?
		;;
	"--initvim"|"-V")
		_init_vim "$2"
		exit $?
		;;
	*)
		echo "Invalid usage, please see 'rc --help' or 'rc -h' for informations" > /dev/stderr
		exit 1
		;;
esac
